<!-- base template for the jinja template.
For each network to be shown, the program internally builds the parent of this template
from sphinx generated report html and then copies this file to the specific network location
Edit it as a normal jinja template BUT DO NOT WRITE "extends..." at the beginning of this file 
as it will be appended dynamically by the program for each given network

NOTE: When calling render_template in flask, you usually write it as
render_template(templatename.html,...), and flask will search inside its template folder.
templatename.html can be a path RELATIVE to the flask template folder. When working with blueprints,
if we set a template folder for a blueprint and call flask.render_template, conflicts might arise
Think about this: app template folder: /app/templates
blueprint template folder: /someotherlocation/templates
If both have a file index.html in it, calling flask.render_template('index.html') results in
unexpected results. So it is important that templatename.html is uniquely identified, even as
relative path (to one of the templates folder), and even "extends templatepath" here
should account for that
-->

{% block extrahead %}
	<link rel="stylesheet" href="static/css/bootstrap/css/bootstrap.min.css" />
	<link rel="stylesheet" href="static/css/editable_page_style.css" />
	<link rel="stylesheet" href="static/js/leaflet/leaflet.css" />
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script> -->
	<script src="static/js/angular.min.js"></script>
	<script src="static/js/leaflet/leaflet.js"></script>
	<script src="static/js/esri-leaflet.js"></script>
	<script src="static/js/ace-build/ace.js"></script>
{% endblock %}

{% block header %}  <!-- BODY header (empty by default, call super for safety) -->

<!-- <a style="float:left" href='http://www.gfz-potsdam.de' target = "_blank">
<img src="_static/GFZ-Logo_eng_RGB.png" />
</a> -->
	{{ super() }}
{% endblock %}


{% block document %}
	<div ng-app="MyApp" ng-controller="MyController">
	
		<script type="text/javascript">
        /* angularjs stuff: To be done NOW so the controller is initialized and elements
        show up their defaults. FIXME: move to a separate js*/
        var app = angular.module('MyApp', []);
        app.controller('MyController', function ($scope, $http, $window) {
            //This will hide the DIV by default.
            $scope.network = "{{ network_name }}";
            $scope.aceEditor = $window.editor;
            $scope.isModified = false;
            $scope.isEditing = false;
            $scope.needsRefresh = false;
            $scope.versioned_files = undefined; //not yest supported, should hold the versioned file name
            $scope.refresh = function() {
   				$window.location.reload();
			}
            $scope.save = function() {
			    /* the $http service allows you to make arbitrary ajax requests.
			     * in this case you might also consider using angular-resource and setting up a
			     * User $resource. */
			    $http.post('/' + $scope.network + '/save',
			    		   JSON.stringify({ text: $scope.aceEditor.getValue() }),
			    		   {headers: { 'Content-Type': 'application/json' }}
			    		   )
			    .then(
					  function(response){ // success callback
         			  	$scope.isModified = false;
	        			$scope.needsRefresh = true;
       				  },
       				  function(response){ // failure callback
         				console.log("failed :(", failure);
       				  }
    				  );
		    };
		    $scope.viewPdf = function() {
		    	url = $scope.network + '/pdf';  //no starting slashes, make it relative to this page 
		    	$window.open(url,'_blank');
		    };
        });
		</script>

  		<ul class="nav nav-tabs">
  			<li ng-class="{'active' : !isEditing, '': isEditing}"><a href ng-click='isEditing=false'>Html</a></li>
  			<li ng-class="{'active' : isEditing, '': !isEditing}"><a href ng-click='isEditing=true'>Source</a></li>
		</ul>
		
		<div id="editor_panel">
			<button ng-click="save()" ng-disabled='!isModified' class='btn btn-primary btn-sm'
				style="display: none" id=save_btn ng-style="{display: isEditing ? 'inline-block': 'none'}">
				Save
			</button>
			<button ng-click="viewPdf()" ng-disabled='needsRefresh' class='btn btn-primary btn-sm'
				style="display: inline-block">
				View pdf
			</button>
			<button ng-click="refresh()" ng-disabled='!needsRefresh' class='btn btn-primary btn-sm'
				style="display: inline-block" id=refresh_btn">
				Refresh
			</button>
		</div>
		
		
		<!-- ace container: -->
		<div id='editor' style="display: none" ng-style="{display: isEditing ? 'block' : 'none'}">
		</div>
		<div id=report_wrapper ng-style="{display: isEditing ? 'none' : 'block'}">
			{{ super() }}
		</div>
	</div>
{% endblock %}

{% block footer %}
{{ super() }}
    <script type="text/javascript">
        
        /* ace stuff: */
	    var editor = ace.edit("editor");
	    /*editor.setTheme("ace/theme/vibrant_ink");*/
	    editor.setTheme("ace/theme/clouds");
	    editor.getSession().setMode("ace/mode/rst");
	    editor.setValue("{{ source_data | safe }}");
	    editor.clearSelection();
	    editor.setOptions({
  			fontFamily: "'Menlo', 'Ubuntu Mono', 'monospace'",
  			//fontSize: "10pt",
  			//showPrintMargin: true,
			printMarginColumn: 100
		});
		
		/* add listener for the buttons save and save compile.
		For info see: http://stackoverflow.com/questions/19670178/ace-editor-change-event
		*/

		/* 
		   using input event instead of change since it's called with some timeout
		   Note that the event below IS CALLED ANYWAY AT PAGE LOAD
		   possibly after setValue above??
		   In order to know if it's not the first time, we set a global variable:
		*/
		var _$_editor__UNINIT = true; //the name is weird to avoid conflicts (it's global)
		//and we will use it below
		editor.on("input", function() {
			if (_$_editor__UNINIT){
        		_$_editor__UNINIT = false; //this is called at page load, just set the flag
        		//to enter the other if branch (here below) the next time
        		
        		/* 
        		   reset the undo manager (for safety, maybe we will use it in future releases)
        		   for info, see:
        		   http://stackoverflow.com/questions/30986732/reset-the-undo-stack-in-ace-editor
        		   the undo manager seems not to be clean at startup
        		   probably cause this method is fired with some timeout
        		   from editor.setValue
        		*/
        		editor.getSession().setUndoManager(new ace.UndoManager());
        	}
			isMod = !editor.session.getUndoManager().isClean();
			/* set the angular scope variable and see if it's working
			For info on how to access angular scope from within the normal DOM, see:
			http://stackoverflow.com/questions/17656244/how-to-change-angularjs-data-outside-the-scope
			*/
			var $scope = angular.element(document.getElementById('save_btn')).scope();
			$scope.$apply(function() {
        		$scope.isModified = isMod;
    		});
		});
    </script>
{% endblock %}